{
  "QueueProcessor": {
    "Enabled": true,
    "QueueServiceUri": "https://yourstorageaccount.queue.core.windows.net",
  "QueueName": "secureboot-reports",
    "AuthenticationMethod": "ManagedIdentity",
    "MaxMessages": 10,
    "ProcessingInterval": "00:00:05",
    "EmptyQueuePollInterval": "00:00:30",
    "VisibilityTimeout": "00:05:00",
    "MaxDequeueCount": 5
  }
}

// ????????????????????????????????????????????????????????????????????????????
// QUEUE PROCESSOR AUTHENTICATION - ESEMPI CONFIGURAZIONE API
// ????????????????????????????????????????????????????????????????????????????

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 1: Managed Identity (RACCOMANDATO per Azure App Service)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo quando l'API � deployata su Azure App Service, Container Instance, o AKS.
// ZERO secrets da gestire!
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "QueueProcessor": {
    "Enabled": true,
    "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
    "QueueName": "secureboot-reports",
    "AuthenticationMethod": "ManagedIdentity"
    // Nessun ClientId, TenantId, Secret, o Certificate richiesto!
  }
}

Setup per Azure App Service:
1. Abilita System-Assigned Managed Identity:
   > az webapp identity assign --name app-secureboot-api-prod --resource-group rg-secureboot-prod

2. Ottieni il Principal ID:
   > PRINCIPAL_ID=$(az webapp identity show --name app-secureboot-api-prod --resource-group rg-secureboot-prod --query principalId -o tsv)

3. Assegna ruolo "Storage Queue Data Contributor":
   > az role assignment create \
     --role "Storage Queue Data Contributor" \
     --assignee $PRINCIPAL_ID \
     --scope "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{storage}"

4. Imposta Enabled=true nella configurazione Azure App Service:
   > az webapp config appsettings set \
     --name app-secureboot-api-prod \
     --resource-group rg-secureboot-prod \
     --settings QueueProcessor__Enabled=true

Vantaggi:
? ZERO secrets da gestire
? Rotazione automatica credenziali
? Massima sicurezza
? Setup semplicissimo
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 2: Certificate (Produzione on-premises o VM non-Azure)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo per server on-premises o VM non-Azure con elevata sicurezza.
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "QueueProcessor": {
"Enabled": true,
    "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
    "QueueName": "secureboot-reports",
    "AuthenticationMethod": "Certificate",
    "TenantId": "12345678-1234-1234-1234-123456789abc",
    "ClientId": "87654321-4321-4321-4321-210987654321",
    "CertificateThumbprint": "1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P7Q8R9S0T",
    "CertificateStoreLocation": "LocalMachine",
    "CertificateStoreName": "My"
  }
}

Setup:
1. Crea App Registration in Azure Portal
2. Genera certificato e upload in App Registration
3. Installa certificato nel server: Cert:\LocalMachine\My
4. Assegna ruolo RBAC al Service Principal

PowerShell per installare certificato:
> $password = ConvertTo-SecureString -String "YourPfxPassword" -Force -AsPlainText
> Import-PfxCertificate -FilePath "SecureBootAPI.pfx" -CertStoreLocation "Cert:\LocalMachine\My" -Password $password

Vantaggi:
? Certificato protetto da Windows
? Supporto HSM/TPM
? Massima sicurezza on-premises
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 3: App Registration + Client Secret (Quick Setup)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo per setup rapido o ambienti non-produzione.
// ?? Client Secret va in Azure Key Vault o variabili d'ambiente!
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "QueueProcessor": {
    "Enabled": true,
    "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
    "QueueName": "secureboot-reports",
    "AuthenticationMethod": "AppRegistration",
    "TenantId": "12345678-1234-1234-1234-123456789abc",
    "ClientId": "87654321-4321-4321-4321-210987654321"
    // ?? ClientSecret va in variabili d'ambiente, NON qui!
  }
}

Setup Secret (Azure App Service):
> az webapp config appsettings set \
  --name app-secureboot-api-prod \
  --resource-group rg-secureboot-prod \
  --settings QueueProcessor__ClientSecret="your-secret-value"

Oppure in Azure Key Vault:
> az keyvault secret set \
  --vault-name your-keyvault \
  --name "QueueProcessor--ClientSecret" \
  --value "your-secret-value"

?? Ruota il secret ogni 6-12 mesi!
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 4: DefaultAzureCredential (Sviluppo Locale)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo per sviluppo locale. Prova automaticamente: Azure CLI, Visual Studio, ecc.
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "QueueProcessor": {
    "Enabled": true,
    "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
    "QueueName": "secureboot-reports",
    "AuthenticationMethod": "DefaultAzureCredential"
  }
}

Setup sviluppo locale:
> az login
> az role assignment create \
  --role "Storage Queue Data Contributor" \
  --assignee "your-email@domain.com" \
  --scope "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{storage}"

Vantaggi:
? Funziona in sviluppo locale e produzione Azure
? Prova pi� metodi automaticamente
? Stesso codice ovunque
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 5: Connection String (SOLO SVILUPPO - NON RACCOMANDATO)
// ??????????????????????????????????????????????????????????????????????????
// ?? NON usare in produzione! Solo per test locali rapidi.
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "QueueProcessor": {
    "Enabled": true,
    "AuthenticationMethod": "ConnectionString",
    "ConnectionString": "DefaultEndpointsProtocol=https;AccountName=stsecurebootprod;AccountKey=...;EndpointSuffix=core.windows.net",
    "QueueName": "secureboot-reports"
  }
}

?? IMPORTANTE:
- NON committare la connection string
- Usa appsettings.Development.json (ignorato da Git)
- Solo per test locali
- MAI in produzione
*/

// ??????????????????????????????????????????????????????????????????????????
// CONFIGURAZIONE PARAMETRI AVANZATI
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "QueueProcessor": {
    "Enabled": true,
    "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
    "QueueName": "secureboot-reports",
    "AuthenticationMethod": "ManagedIdentity",

    // Performance Tuning
    "MaxMessages": 32,       // Messaggi per batch (1-32)
    "ProcessingInterval": "00:00:02",     // 2 secondi quando ci sono messaggi
    "EmptyQueuePollInterval": "00:01:00", // 1 minuto quando queue vuota

    // Reliability
    "VisibilityTimeout": "00:10:00",      // 10 minuti per processare
    "MaxDequeueCount": 3// Max retry prima di considerare poison
  }
}

Tuning Guidelines:
????????????????????????????????????????????????????????????????????????
? Scenario          ? MaxMessages  ? ProcessingInterval          ?
????????????????????????????????????????????????????????????????????????
? Basso volume (<100/h)   ? 5            ? 30 secondi      ?
? Medio volume (100-1k/h) ? 10 (default) ? 5 secondi (default)         ?
? Alto volume (>1k/h)     ? 32      ? 1-2 secondi           ?
????????????????????????????????????????????????????????????????????????

VisibilityTimeout Recommendations:
- Pi� alto se processing richiede tempo (es. validazioni complesse)
- Pi� basso per retry veloci
- Default: 5 minuti � un buon compromesso

MaxDequeueCount:
- 3-5 � raccomandato (default: 5)
- Troppo basso ? falsi positivi (messaggi validi scartati)
- Troppo alto ? messaggi invalidi processati infinite volte
*/

// ??????????????????????????????????????????????????????????????????????????
// MATRICE DECISIONE: QUALE METODO USARE?
// ??????????????????????????????????????????????????????????????????????????
/*
????????????????????????????????????????????????????????????????????
? Dove � deployata l'API    ? Metodo Raccomandato ? Setup Required ?
????????????????????????????????????????????????????????????????????
? ?? Azure App Service      ? ManagedIdentity     ? Abilita MI     ?
? ?? Azure Container App    ? ManagedIdentity     ? Abilita MI     ?
? ?? Azure AKS     ? ManagedIdentity     ? Abilita MI     ?
? ??? On-premises (secure)   ? Certificate     ? Installa cert  ?
? ??? On-premises (standard) ? AppRegistration     ? Crea secret    ?
? ?? Sviluppo locale        ? DefaultAzure...     ? az login       ?
????????????????????????????????????????????????????????????????????

REGOLA D'ORO:
Su Azure ? Managed Identity (SEMPRE!)
On-premises ? Certificate > App Registration
Sviluppo ? DefaultAzureCredential
Mai in prod ? Connection String
*/

// ??????????????????????????????????????????????????????????????????????????
// DEPLOYMENT CHECKLIST
// ??????????????????????????????????????????????????????????????????????????
/*
Azure App Service Deployment:

1. ? Abilita Managed Identity sull'App Service
   > az webapp identity assign --name {app-name} --resource-group {rg}

2. ? Assegna ruolo RBAC Storage Queue Data Contributor
   > az role assignment create --role "Storage Queue Data Contributor" --assignee {principal-id} --scope {storage-scope}

3. ? Configura appsettings in Azure Portal o CLI
   > az webapp config appsettings set --settings QueueProcessor__Enabled=true QueueProcessor__QueueServiceUri=https://... ...

4. ? Verifica nei logs che il servizio parte correttamente
   > az webapp log tail --name {app-name} --resource-group {rg}
   Cerca: "Queue processor started successfully"

5. ? Testa inviando un messaggio alla queue dal Client
   Client ? Queue ? API logs dovrebbero mostrare: "Received 1 message(s) from queue"

6. ? Verifica che i report vengano salvati nel database
   Query SQL: SELECT TOP 10 * FROM SecureBootReports ORDER BY CreatedAtUtc DESC;

On-Premises Deployment:

1. ? Crea App Registration in Azure Portal
2. ? Genera e installa certificato nel server
3. ? Configura appsettings.json con Tenant, Client ID, Thumbprint
4. ? Assegna ruolo RBAC al Service Principal
5. ? Testa la connessione prima del deployment
6. ? Deploy e monitora logs

Sviluppo Locale:

1. ? az login con account che ha accesso alla queue
2. ? Assegna ruolo RBAC al tuo account
3. ? Imposta Enabled=true in appsettings.Development.json
4. ? Avvia API in debug: dotnet run
5. ? Verifica logs: "Queue processor started successfully"
*/

// ??????????????????????????????????????????????????????????????????????????
// MONITORING E TROUBLESHOOTING
// ??????????????????????????????????????????????????????????????????????????
/*
Log Levels:
- Information: Startup, messaggi processati, shutdown
- Warning: Connection string usage, retry, poison messages
- Error: Autenticazione fallita, deserializzazione fallita

Logs Chiave da Monitorare:

Startup:
? "Queue processor starting. Queue: secureboot-reports, AuthMethod: ManagedIdentity"
? "Using Managed Identity authentication"
? "Queue processor started successfully"

Processing:
? "Received 10 message(s) from queue secureboot-reports"
? "Saved report {guid} for device MACHINE01 from queue message {id}"
? "Successfully processed and deleted message {id}"

Errors:
? "Failed to create queue client"
? "Queue secureboot-reports does not exist"
? "Failed to receive messages from queue"
? "Failed to deserialize message {id}. Invalid JSON format"
? "Message {id} exceeded max dequeue count"

Troubleshooting:

Errore: "Failed to create queue client"
? Verifica QueueServiceUri, TenantId, ClientId nella configurazione
? Verifica che Managed Identity sia abilitata (se ManagedIdentity)
? Verifica che il certificato sia installato (se Certificate)

Errore: "Queue does not exist"
? Verifica che la queue esista: az storage queue exists --name secureboot-reports ...
? Verifica che il nome sia corretto nella configurazione

Errore: "AuthenticationFailed" o "403 Forbidden"
? Verifica che il ruolo RBAC sia assegnato: az role assignment list --assignee {principal-id}
? Attendi fino a 5 minuti per propagazione permessi
? Verifica lo scope del ruolo (deve includere lo storage account)

Errore: "Failed to deserialize message"
? Verifica che il Client invii il formato corretto (SecureBootQueueEnvelope)
? Verifica la versione del Client sia compatibile

Poison Messages:
? Se un messaggio supera MaxDequeueCount, viene loggato e eliminato
? Considera di implementare una poison queue per analisi manuale
? Monitora il log per "exceeded max dequeue count"
*/
