{
    "Logging": {
        "LogLevel": {
            "Default": "Information",
            "Microsoft": "Warning",
            "Azure": "Warning"
        }
    },
    "SecureBootWatcher": {
        "FleetId": "production-fleet",
        "RunMode": "Once",
        "RegistryPollInterval": "00:30:00",
        "EventQueryInterval": "00:30:00",
        "EventLookbackPeriod": "1.00:00:00",
        "EventChannels": [
            "Microsoft-Windows-DeviceManagement-Enterprise-Diagnostics-Provider/Admin",
            "Microsoft-Windows-CodeIntegrity/Operational"
        ],
        "Sinks": {
            "EnableFileShare": false,
            "EnableAzureQueue": true,
            "EnableWebApi": false,
            "AzureQueue": {
                "QueueServiceUri": "https://yourstorageaccount.queue.core.windows.net",
                "QueueName": "secureboot-reports",
                "AuthenticationMethod": "Certificate",
                "TenantId": "00000000-0000-0000-0000-000000000000",
                "ClientId": "11111111-1111-1111-1111-111111111111",
                "CertificateThumbprint": "ABC123DEF456789",
                "CertificateStoreLocation": "LocalMachine",
                "CertificateStoreName": "My",
                "VisibilityTimeout": "00:05:00",
                "MaxSendRetryCount": 5
            }
        }
    }
}

// ????????????????????????????????????????????????????????????????????????????
// APP REGISTRATION AUTHENTICATION - ESEMPI CONFIGURAZIONE
// ????????????????????????????????????????????????????????????????????????????

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 1: Certificate da Windows Certificate Store (RACCOMANDATO PRODUZIONE)
// ??????????????????????????????????????????????????????????????????????????
// Questo � il metodo PI� SICURO per produzione.
// Il certificato � protetto da Windows e pu� usare HSM.
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
      "EnableAzureQueue": true,
      "AzureQueue": {
        "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
        "QueueName": "secureboot-reports",
   "AuthenticationMethod": "Certificate",
        "TenantId": "12345678-1234-1234-1234-123456789abc",
    "ClientId": "87654321-4321-4321-4321-210987654321",
        "CertificateThumbprint": "1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P7Q8R9S0T",
        "CertificateStoreLocation": "LocalMachine",
        "CertificateStoreName": "My"
      }
    }
  }
}

Setup:
1. Crea App Registration in Azure Portal ? Entra ID ? App registrations
2. Genera certificato:
   PowerShell> $cert = New-SelfSignedCertificate -Subject "CN=SecureBoot Watcher" -CertStoreLocation "Cert:\LocalMachine\My" -KeyLength 2048 -NotAfter (Get-Date).AddYears(2)
   PowerShell> Export-Certificate -Cert $cert -FilePath "SecureBootWatcher.cer"
   
3. Upload certificato in App Registration ? Certificates & secrets ? Upload certificate
4. Assegna ruolo RBAC:
   > az ad sp list --filter "appId eq '{ClientId}'" --query "[0].id" -o tsv
   > az role assignment create --role "Storage Queue Data Contributor" --assignee {sp-object-id} --scope "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{storage}"

Vantaggi:
? Certificato protetto da Windows (pu� usare TPM/HSM)
? Nessun file .pfx da gestire
? Revoca immediata se compromesso
? Audit completo in Entra ID
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 2: Certificate da File .pfx (Deployment Alternativo)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo se non puoi installare il certificato nello store.
// ?? Proteggi il file .pfx e la sua password!
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
  "EnableAzureQueue": true,
      "AzureQueue": {
        "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
   "QueueName": "secureboot-reports",
        "AuthenticationMethod": "Certificate",
     "TenantId": "12345678-1234-1234-1234-123456789abc",
      "ClientId": "87654321-4321-4321-4321-210987654321",
        "CertificatePath": "C:\\Program Files\\SecureBootWatcher\\SecureBootWatcher.pfx"
        // ?? CertificatePassword va in variabili d'ambiente, NON qui!
      }
  }
  }
}

Setup Password:
PowerShell> $env:SECUREBOOT_Sinks__AzureQueue__CertificatePassword = "YourPfxPassword123!"

Oppure in Azure Key Vault:
> az keyvault secret set --vault-name your-keyvault --name "SecureBootWatcher--CertPassword" --value "YourPfxPassword123!"

Esporta certificato con chiave privata:
PowerShell> $password = ConvertTo-SecureString -String "YourPfxPassword123!" -Force -AsPlainText
PowerShell> Export-PfxCertificate -Cert $cert -FilePath "SecureBootWatcher.pfx" -Password $password

?? Proteggi il file .pfx:
- Imposta ACL restrittive (solo SYSTEM pu� leggere)
- Non committarlo in Git
- Considera di cifrarlo con DPAPI
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 3: App Registration con Client Secret (Meno Sicuro)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo solo se non puoi usare certificati.
// Richiede rotazione manuale del secret.
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
      "EnableAzureQueue": true,
      "AzureQueue": {
 "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
        "QueueName": "secureboot-reports",
"AuthenticationMethod": "AppRegistration",
        "TenantId": "12345678-1234-1234-1234-123456789abc",
        "ClientId": "87654321-4321-4321-4321-210987654321"
        // ?? ClientSecret va in variabili d'ambiente o Key Vault, NON qui!
  }
    }
  }
}

Setup:
1. Crea App Registration
2. Genera Client Secret:
   > az ad app credential reset --id {ClientId} --append --display-name "SecureBoot Secret" --years 1
   
3. Salva il secret in modo sicuro:
   PowerShell> $env:SECUREBOOT_Sinks__AzureQueue__ClientSecret = "your-secret-value"
   
   Oppure Key Vault:
   > az keyvault secret set --vault-name your-keyvault --name "SecureBootWatcher--ClientSecret" --value "your-secret-value"

4. Assegna ruolo RBAC (come Scenario 1)

?? IMPORTANTE:
- Ruota il secret ogni 6-12 mesi
- Monitora la scadenza
- Non usare lo stesso secret in dev e prod
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 4: Managed Identity (Azure VM/App Service) - PI� SEMPLICE
// ??????????????????????????????????????????????????????????????????????????
// Se il client � deployato su Azure, usa Managed Identity.
// ZERO configurazione secrets richiesta!
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
      "EnableAzureQueue": true,
  "AzureQueue": {
        "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
    "QueueName": "secureboot-reports",
   "AuthenticationMethod": "ManagedIdentity"
        // Nessun ClientId, TenantId, Secret, o Certificate richiesto!
      }
    }
  }
}

Setup (per Azure VM):
> az vm identity assign --name my-vm --resource-group my-rg
> PRINCIPAL_ID=$(az vm identity show --name my-vm --resource-group my-rg --query principalId -o tsv)
> az role assignment create --role "Storage Queue Data Contributor" --assignee $PRINCIPAL_ID --scope "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{storage}"

Vantaggi:
? ZERO secrets da gestire
? Rotazione automatica delle credenziali
? Setup semplicissimo
? Sicurezza massima

Usa questo SE e SOLO SE:
- Il client � su Azure VM
- Il client � su Azure App Service
- Il client � su Azure Container Instance
- Il client � su Azure Kubernetes Service (AKS)
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 5: DefaultAzureCredential (Sviluppo + Produzione)
// ??????????????????????????????????????????????????????????????????????????
// Prova automaticamente pi� metodi. Perfetto per codice che gira ovunque.
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
      "EnableAzureQueue": true,
      "AzureQueue": {
        "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
     "QueueName": "secureboot-reports",
        "AuthenticationMethod": "DefaultAzureCredential"
    // Prova: Environment Variables ? Managed Identity ? Azure CLI ? Visual Studio
      }
    }
  }
}

Setup sviluppo locale:
> az login
> az role assignment create --role "Storage Queue Data Contributor" --assignee "your-email@domain.com" --scope "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{storage}"

Setup produzione:
- Su Azure ? Abilita Managed Identity (come Scenario 4)
- On-premises ? Imposta variabili d'ambiente per Service Principal:
  PowerShell> $env:AZURE_TENANT_ID = "your-tenant-id"
  PowerShell> $env:AZURE_CLIENT_ID = "your-client-id"
  PowerShell> $env:AZURE_CLIENT_SECRET = "your-secret"

Vantaggi:
? Funziona ovunque senza modifiche al codice
? Sviluppo locale: usa `az login`
? Azure: usa Managed Identity automaticamente
? On-premises: usa variabili d'ambiente

Questo � il metodo "universale" - se non sei sicuro, usa questo!
*/

// ??????????????????????????????????????????????????????????????????????????
// CONFRONTO METODI: APP REGISTRATION vs MANAGED IDENTITY
// ??????????????????????????????????????????????????????????????????????????
/*
???????????????????????????????????????????????????????????????????????????????????
? Aspetto           ? App Registration       ? Managed Identity        ?
???????????????????????????????????????????????????????????????????????????????????
? Gestione secrets     ? Richiesta ? Automatica (ZERO)       ?
? Sicurezza          ? ????? (cert) ? ?????     ?
?       ? ???? (secret)   ? ?
? Complessit� setup    ? Media   ? Bassa                   ?
? Rotazione credenziali        ? Manuale        ? Automatica       ?
? Audit logs         ? Completi           ? Completi    ?
? Conditional Access    ? Supportato       ? Limitato        ?
? Multi-tenant support         ? S�       ? No     ?
? On-premises support  ? S�             ? No            ?
? Azure VM/App Service    ? Possibile        ? Ideale         ?
? Costo gestione   ? Medio          ? Basso           ?
???????????????????????????????????????????????????????????????????????????????????
? RACCOMANDATO PER:    ?           ?      ?
? - Azure resources            ? ?            ? ? S� (preferred)  ?
? - On-premises servers        ? ? S�          ? ?      ?
? - Hybrid (Azure + on-prem)   ? ? S�          ? ? (solo parte Azure)   ?
? - Multi-tenant scenarios     ? ? S�    ? ?          ?
? - High-security requirements ? ? S� (cert)   ? ? S�       ?
???????????????????????????????????????????????????????????????????????????????????

REGOLA D'ORO:
?????????????????????????????????????????????????????
? Sei su Azure?       ?
? ?? S� ? Managed Identity     ?
? ?? NO ? App Registration + Certificate   ?
?                ?
? Hai bisogno di multi-tenant?              ?
? ?? S� ? App Registration            ?
?  ?
? Hai bisogno di Conditional Access policies?       ?
? ?? S� ? App Registration    ?
?     ?
? Vuoi ZERO gestione secrets?     ?
? ?? S� ? Managed Identity (se su Azure)   ?
?     ?
? Non sei sicuro? ?
? ?? DefaultAzureCredential (funziona ovunque!)  ?
?????????????????????????????????????????????????????
*/

// ??????????????????????????????????????????????????????????????????????????
// SICUREZZA: CHECKLIST PRODUZIONE
// ??????????????????????????????????????????????????????????????????????????
/*
App Registration con Certificate:
? Genera certificato con almeno 2048-bit key
? NON usare certificati self-signed in produzione (usa CA interna o pubblica)
? Installa certificato in LocalMachine\My store (non file .pfx)
? Imposta ACL restrittive sul certificato (solo SYSTEM pu� accedere)
? Upload solo certificato pubblico (.cer) in App Registration
? Monitora scadenza certificato (configura alert a 90 giorni)
? Documenta thumbprint e ubicazione certificato
? Pianifica rotazione certificato annuale
? Testa rotazione in ambiente non-prod prima

App Registration con Client Secret:
? Salva secret in Azure Key Vault, MAI in file config
? Usa variabili d'ambiente per secrets locali
? Ruota secret ogni 6-12 mesi
? Usa secrets diversi per dev/test/prod
? Monitora scadenza secret (configura alert)
? Revoca immediatamente se compromesso
? Non committare secrets in Git (check con git-secrets)

Managed Identity:
? Preferisci System-Assigned (se possibile)
? Usa User-Assigned solo se necessario (multiple identities)
? Assegna SOLO il ruolo minimo necessario (Storage Queue Data Contributor)
? Monitora Sign-in logs in Entra ID
? Disabilita identit� immediatamente quando non pi� necessaria

General:
? Abilita diagnostic logs sullo Storage Account
? Monitora tentativi di autenticazione falliti
? Usa Conditional Access per restrizioni geografiche (se App Registration)
? Imposta firewall rules sullo Storage Account (se possibile)
? Abilita Azure Defender per Storage
? Configura alerting per attivit� anomale
? MAI usare Connection String in produzione
? MAI committare secrets/certificates nel repository
? MAI condividere credentials tra ambienti (dev/prod)
? MAI disabilitare TLS/SSL
*/
