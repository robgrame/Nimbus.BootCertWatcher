{
    "Logging": {
        "LogLevel": {
            "Default": "Information",
            "Microsoft": "Warning",
            "Azure": "Warning"
        }
    },
    "SecureBootWatcher": {
        "FleetId": "production-fleet",
        "RunMode": "Once",
        "RegistryPollInterval": "00:30:00",
        "EventQueryInterval": "00:30:00",
        "EventLookbackPeriod": "1.00:00:00",
        "EventChannels": [
            "Microsoft-Windows-DeviceManagement-Enterprise-Diagnostics-Provider/Admin",
            "Microsoft-Windows-CodeIntegrity/Operational"
        ],
        "Sinks": {
            "EnableFileShare": false,
            "FileShare": {
                "RootPath": "\\\\server\\share\\secureboot",
                "FileExtension": ".json",
                "AppendTimestampToFileName": true
            },
            "EnableAzureQueue": true,
            "AzureQueue": {
                "QueueServiceUri": "https://yourstorageaccount.queue.core.windows.net",
                "QueueName": "secureboot-reports",
                "AuthenticationMethod": "DefaultAzureCredential",
                "VisibilityTimeout": "00:05:00",
                "MaxSendRetryCount": 5
            },
            "EnableWebApi": false,
            "WebApi": {
                "BaseAddress": "https://your-api.azurewebsites.net",
                "IngestionRoute": "/api/SecureBootReports",
                "HttpTimeout": "00:00:30"
            }
        }
    }
}

// ????????????????????????????????????????????????????????????????????????????
// ESEMPI DI CONFIGURAZIONE PER DIVERSI SCENARI
// ????????????????????????????????????????????????????????????????????????????

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 1: DefaultAzureCredential (RACCOMANDATO)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo per sviluppo locale e produzione Azure.
// Prova automaticamente: Managed Identity, Azure CLI, Visual Studio, etc.
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
      "EnableAzureQueue": true,
      "AzureQueue": {
    "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
        "QueueName": "secureboot-reports",
    "AuthenticationMethod": "DefaultAzureCredential"
      }
  }
  }
}

Setup sviluppo locale:
> az login
> az role assignment create --role "Storage Queue Data Contributor" --assignee "your-email@domain.com" --scope "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{account}"

Setup produzione Azure VM:
> az vm identity assign --name my-vm --resource-group my-rg
> PRINCIPAL_ID=$(az vm identity show --name my-vm --resource-group my-rg --query principalId -o tsv)
> az role assignment create --role "Storage Queue Data Contributor" --assignee $PRINCIPAL_ID --scope "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{account}"
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 2: System-Assigned Managed Identity (Produzione Azure)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo quando il client � deployato su Azure VM, App Service, AKS
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
      "EnableAzureQueue": true,
      "AzureQueue": {
     "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
        "QueueName": "secureboot-reports",
        "AuthenticationMethod": "ManagedIdentity"
      }
    }
  }
}

Setup:
> az vm identity assign --name my-vm --resource-group my-rg
> PRINCIPAL_ID=$(az vm identity show --name my-vm --resource-group my-rg --query principalId -o tsv)
> az role assignment create --role "Storage Queue Data Contributor" --assignee $PRINCIPAL_ID --scope "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{account}"
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 3: User-Assigned Managed Identity (Pi� identit� gestite)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo quando hai pi� managed identities sulla stessa risorsa
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
   "EnableAzureQueue": true,
    "AzureQueue": {
        "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
        "QueueName": "secureboot-reports",
        "AuthenticationMethod": "ManagedIdentity",
        "ClientId": "12345678-1234-1234-1234-123456789abc"
 }
    }
  }
}

Setup:
> az identity create --name secureboot-identity --resource-group my-rg
> CLIENT_ID=$(az identity show --name secureboot-identity --resource-group my-rg --query clientId -o tsv)
> PRINCIPAL_ID=$(az identity show --name secureboot-identity --resource-group my-rg --query principalId -o tsv)
> az vm identity assign --name my-vm --resource-group my-rg --identities /subscriptions/{sub}/resourceGroups/my-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/secureboot-identity
> az role assignment create --role "Storage Queue Data Contributor" --assignee $PRINCIPAL_ID --scope "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{account}"
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 4: Service Principal (On-Premises / CI/CD)
// ??????????????????????????????????????????????????????????????????????????
// Usa questo per server on-premises o pipeline CI/CD
// ?? NON committare il ClientSecret nel repository!
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
      "EnableAzureQueue": true,
      "AzureQueue": {
        "QueueServiceUri": "https://stsecurebootprod.queue.core.windows.net",
        "QueueName": "secureboot-reports",
        "AuthenticationMethod": "ServicePrincipal",
        "TenantId": "00000000-0000-0000-0000-000000000000",
        "ClientId": "11111111-1111-1111-1111-111111111111"
        // ?? ClientSecret va in variabili d'ambiente o Key Vault, NON qui!
  }
    }
  }
}

Setup Service Principal:
> az ad sp create-for-rbac --name "secureboot-watcher-sp" --role "Storage Queue Data Contributor" --scopes "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{account}"

Salva il ClientSecret in modo sicuro:
> $env:SECUREBOOT_Sinks__AzureQueue__ClientSecret = "your-secret-value"

Oppure in Azure Key Vault:
> az keyvault secret set --vault-name your-keyvault --name "SecureBootWatcher--Sinks--AzureQueue--ClientSecret" --value "your-secret-value"
*/

// ??????????????????????????????????????????????????????????????????????????
// SCENARIO 5: Connection String (SOLO SVILUPPO LOCALE)
// ??????????????????????????????????????????????????????????????????????????
// ?? NON RACCOMANDATO per produzione! Solo per test locali rapidi.
// ??????????????????????????????????????????????????????????????????????????
/*
{
  "SecureBootWatcher": {
    "Sinks": {
   "EnableAzureQueue": true,
      "AzureQueue": {
        "AuthenticationMethod": "ConnectionString",
        "ConnectionString": "DefaultEndpointsProtocol=https;AccountName=stsecurebootprod;AccountKey=abc123...;EndpointSuffix=core.windows.net",
        "QueueName": "secureboot-reports"
      }
    }
  }
}

Ottieni la connection string:
> az storage account show-connection-string --name yourstorageaccount --resource-group your-rg --output tsv

?? IMPORTANTE: NON committare la connection string nel repository!
   Usa appsettings.local.json (gi� ignorato da .gitignore)
*/

// ??????????????????????????????????????????????????????????????????????????
// MATRICE DI DECISIONE: QUALE METODO USARE?
// ??????????????????????????????????????????????????????????????????????????
/*
???????????????????????????????????????????????????????????????????
? Scenario    ? Metodo Raccomandato  ? Sicurezza   ?
???????????????????????????????????????????????????????????????????
? Sviluppo locale        ? DefaultAzureCredential? ????? ?
? Azure VM        ? ManagedIdentity      ? ????? ?
? Azure App Service          ? ManagedIdentity ? ????? ?
? Azure Container Instance   ? ManagedIdentity      ? ????? ?
? Azure Kubernetes (AKS)     ? ManagedIdentity      ? ????? ?
? Server on-premises         ? ServicePrincipal     ? ????   ?
? CI/CD Pipeline  ? ServicePrincipal     ? ????   ?
? Test locale rapido         ? ConnectionString   ? ? (solo dev)?
???????????????????????????????????????????????????????????????????

REGOLA D'ORO:
- Se sei su Azure ? Managed Identity
- Se sei on-premises ? Service Principal
- Se non sei sicuro ? DefaultAzureCredential (prova tutto automaticamente)
- MAI ConnectionString in produzione
*/

// ??????????????????????????????????????????????????????????????????????????
// CHECKLIST SICUREZZA
// ??????????????????????????????????????????????????????????????????????????
/*
? Usa Managed Identity o DefaultAzureCredential quando possibile
? Assegna solo il ruolo "Storage Queue Data Contributor" (principio least privilege)
? Ruota i Client Secrets regolarmente (se usi Service Principal)
? Salva secrets in Azure Key Vault, non in file di configurazione
? Usa appsettings.local.json per configurazioni con secrets (gi� in .gitignore)
? Abilita diagnostic logs sullo Storage Account per audit
? MAI committare ConnectionString o ClientSecret nel repository
? MAI usare ruoli Owner/Contributor quando basta Data Contributor
? MAI usare ConnectionString in produzione
*/
